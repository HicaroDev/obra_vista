generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

model Usuarios {
  id                 Int                  @id @default(autoincrement())
  nome               String               @db.VarChar(255)
  email              String               @unique @db.VarChar(255)
  senha              String               @db.VarChar(255)
  tipo               String               @default("usuario") @db.VarChar(50)
  ativo              Boolean              @default(true)
  createdAt          DateTime             @default(now()) @db.Timestamp(6)
  updatedAt          DateTime             @default(now()) @updatedAt @db.Timestamp(6)
  telefone           String?              @db.VarChar(50)
  cargo              String?              @db.VarChar(100)
  avatar_url         String?              @db.VarChar(500)
  ultimo_acesso      DateTime?            @db.Timestamp(6)
  equipes            Equipes_Membros[]
  logs               Logs[]
  tarefa_ocorrencias tarefa_ocorrencias[]
  usuario_roles      usuario_roles[]
  permissoes_custom  Json?                @default("{}")
  crm_interacoes     CrmInteracao[]

  @@index([email], map: "idx_usuarios_email")
  @@map("usuarios")
  @@schema("public")
  movimentacoesFerramentas MovimentacaoFerramentas[]
}

model Prestadores {
  id            Int               @id @default(autoincrement())
  nome          String            @db.VarChar(255)
  especialidade String            @db.VarChar(255)
  telefone      String?           @db.VarChar(50)
  email         String?           @db.VarChar(255)
  cpf           String?           @unique @db.VarChar(14)
  ativo         Boolean           @default(true)
  createdAt     DateTime          @default(now()) @db.Timestamp(6)
  updatedAt     DateTime          @default(now()) @updatedAt @db.Timestamp(6)
  tipo_pessoa     String?         @default("PF") @db.VarChar(2)
  cnpj            String?         @unique @db.VarChar(18)
  
  // Dados de Pagamento / Pix
  pix_tipo        String?         @db.VarChar(20)
  pix_chave       String?         @db.VarChar(100)
  
  // Dados de Contratação
  tipo_contrato         String?   @default("diaria") @db.VarChar(20) // diaria, empreita, clt
  valor_diaria          Decimal?  @db.Decimal(10, 2)
  valor_vale_refeicao   Decimal?  @db.Decimal(10, 2)
  valor_vale_transporte Decimal?  @db.Decimal(10, 2)
  salario               Decimal?  @db.Decimal(10, 2)
  bonificacao           Decimal?  @db.Decimal(10, 2)
  
  // Específico CLT
  dia_pagamento         Int?      // Dia do mês para pagamento de salário (ex: 5)
  dia_vale              Int?      // Dia do mês para pagamento do vale (ex: 20)
  valor_adiantamento    Decimal?  @db.Decimal(10, 2) // Valor fixo do vale/adiantamento
  usa_folha_ponto       Boolean   @default(true) // Se deve aparecer na folha de ponto
  atribuicoes   Atribuicoes[]
  equipes       Equipes_Membros[]
  frequencia    Frequencia[]
  descontos     Desconto[]

  @@index([cnpj], map: "idx_prestadores_cnpj")
  @@index([cpf], map: "idx_prestadores_cpf")
  @@map("prestadores")
  @@schema("public")
  movimentacoesFerramentas MovimentacaoFerramentas[]
}

model Equipes {
  id          Int               @id @default(autoincrement())
  nome        String            @db.VarChar(255)
  descricao   String?
  cor         String?           @default("#3B82F6") @db.VarChar(7)
  ativa       Boolean           @default(true)
  createdAt   DateTime          @default(now()) @db.Timestamp(6)
  updatedAt   DateTime          @default(now()) @updatedAt @db.Timestamp(6)
  atribuicoes Atribuicoes[]
  membros     Equipes_Membros[]

  @@map("equipes")
  @@schema("public")
}

model Equipes_Membros {
  id          Int          @id @default(autoincrement())
  equipeId    Int
  usuarioId   Int?
  prestadorId Int?
  papel       String       @default("membro") @db.VarChar(50)
  createdAt   DateTime     @default(now()) @db.Timestamp(6)
  equipe      Equipes      @relation(fields: [equipeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  prestador   Prestadores? @relation(fields: [prestadorId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  usuario     Usuarios?    @relation(fields: [usuarioId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([equipeId, usuarioId])
  @@unique([equipeId, prestadorId])
  @@index([equipeId], map: "idx_equipes_membros_equipeid")
  @@index([prestadorId], map: "idx_equipes_membros_prestadorid")
  @@index([usuarioId], map: "idx_equipes_membros_usuarioid")
  @@map("equipes_membros")
  @@schema("public")
}

model Obras {
  id          Int           @id @default(autoincrement())
  nome        String        @db.VarChar(255)
  endereco    String        @db.VarChar(500)
  descricao   String?
  status      String        @default("planejamento") @db.VarChar(50)
  dataInicio  DateTime?     @db.Timestamp(6)
  dataFim     DateTime?     @db.Timestamp(6)
  orcamento   Decimal?      @db.Decimal(10, 2)
  createdAt   DateTime      @default(now()) @db.Timestamp(6)
  updatedAt   DateTime      @default(now()) @updatedAt @db.Timestamp(6)
  atribuicoes Atribuicoes[]
  frequencia  Frequencia[]

  @@index([status], map: "idx_obras_status")
  @@map("obras")
  @@schema("public")
  movimentacoesFerramentas MovimentacaoFerramentas[]
  orcamento_detalhado Orcamento[] // Alterado para 1:N para permitir templates e versões
  
  // CRM Relations
  crmDeal     CrmDeal?
  leadId      Int?
  lead        CrmLead? @relation(fields: [leadId], references: [id])
}

model Orcamento {
  id        Int      @id @default(autoincrement())
  obraId    Int?     
  obra      Obras?   @relation(fields: [obraId], references: [id], onDelete: Cascade)
  nome      String   @db.VarChar(255)
  valorTotal Decimal? @default(0) @db.Decimal(15, 2)
  bdi       Decimal? @default(0) @db.Decimal(5, 2) // Percentual, ex: 25.00
  dataBase  DateTime? @db.Date
  isTemplate Boolean  @default(false)
  
  itens     OrcamentoItem[]
  
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(6)
  
  @@map("orcamentos")
  @@schema("public")
}

model OrcamentoItem {
  id             Int        @id @default(autoincrement())
  orcamentoId    Int
  orcamento      Orcamento  @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  
  wbs            String?    @db.VarChar(50) // Hierarquia: 1, 1.1, 1.1.2
  codigo         String?    @db.VarChar(50) // Código da composição: ADM-01
  descricao      String
  unidade        String?    @db.VarChar(20)
  quantidade     Decimal?   @default(0) @db.Decimal(12, 4)
  
  // Custos Unitários
  custoMaterial    Decimal?   @default(0) @db.Decimal(12, 2)
  custoMaoDeObra   Decimal?   @default(0) @db.Decimal(12, 2)
  custoEquipamento Decimal?   @default(0) @db.Decimal(12, 2)
  
  valorUnitario  Decimal?   @default(0) @db.Decimal(12, 2) // Soma dos custos diretos unitários
  valorTotal     Decimal?   @default(0) @db.Decimal(15, 2) // Com BDI
  
  tipo           String     @default("composicao") @db.VarChar(20) // "etapa" (agrupador) ou "composicao" (item)
  
  insumos        ComposicaoInsumo[]
  
  createdAt      DateTime   @default(now()) @db.Timestamp(6)
  updatedAt      DateTime   @default(now()) @updatedAt @db.Timestamp(6)
  
  @@index([orcamentoId], map: "idx_orcamento_itens_orcamento")
  @@map("orcamento_itens")
  @@schema("public")
}

model ComposicaoInsumo {
  id              Int           @id @default(autoincrement())
  orcamentoItemId Int
  orcamentoItem   OrcamentoItem @relation(fields: [orcamentoItemId], references: [id], onDelete: Cascade)
  
  tipo            String        @db.VarChar(50) // "Material", "Mão de Obra", "Equipamento"
  codigo          String?       @db.VarChar(50)
  descricao       String
  unidade         String?       @db.VarChar(20)
  
  quantidade      Decimal?      @default(0) @db.Decimal(12, 4) // Coeficiente de consumo
  custoUnitario   Decimal?      @default(0) @db.Decimal(12, 2)
  custoTotal      Decimal?      @default(0) @db.Decimal(12, 2)
  
  createdAt       DateTime      @default(now()) @db.Timestamp(6)
  
  @@index([orcamentoItemId], map: "idx_composicao_insumos_item")
  @@map("composicao_insumos")
  @@schema("public")
}

model Atribuicoes {
  id                 Int                  @id @default(autoincrement())
  obraId             Int
  equipeId           Int?
  titulo             String               @db.VarChar(255)
  descricao          String?
  status             String               @default("a_fazer") @db.VarChar(50)
  prioridade         String               @default("media") @db.VarChar(50)
  ordem              Int                  @default(0)
  dataInicio         DateTime?            @db.Timestamp(6)
  dataFim            DateTime?            @db.Timestamp(6)
  createdAt          DateTime             @default(now()) @db.Timestamp(6)
  updatedAt          DateTime             @default(now()) @updatedAt @db.Timestamp(6)
  tipo_atribuicao    String?              @default("equipe") @db.VarChar(20)
  prestador_id       Int?
  dias_semana        Json?
  equipe             Equipes?             @relation(fields: [equipeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  obra               Obras                @relation(fields: [obraId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  prestador          Prestadores?         @relation(fields: [prestador_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  logs               Logs[]
  tarefa_anexos      tarefa_anexos[]
  tarefa_checklists  tarefa_checklists[]
  tarefa_compras     tarefa_compras[]
  tarefa_etiquetas   tarefa_etiquetas[]
  tarefa_ocorrencias tarefa_ocorrencias[]

  @@index([equipeId], map: "idx_atribuicoes_equipeid")
  @@index([obraId], map: "idx_atribuicoes_obraid")
  @@index([ordem], map: "idx_atribuicoes_ordem")
  @@index([status], map: "idx_atribuicoes_status")
  @@map("atribuicoes")
  @@schema("public")
}

model Logs {
  id           Int          @id @default(autoincrement())
  usuarioId    Int
  atribuicaoId Int?
  acao         String       @db.VarChar(50)
  entidade     String       @db.VarChar(50)
  detalhes     String?
  createdAt    DateTime     @default(now()) @db.Timestamp(6)
  atribuicao   Atribuicoes? @relation(fields: [atribuicaoId], references: [id], onUpdate: NoAction)
  usuario      Usuarios     @relation(fields: [usuarioId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([atribuicaoId], map: "idx_logs_atribuicaoid")
  @@index([createdAt], map: "idx_logs_createdat")
  @@index([entidade], map: "idx_logs_entidade")
  @@index([usuarioId], map: "idx_logs_usuarioid")
  @@map("logs")
  @@schema("public")
}

model especialidades {
  id        Int      @id @default(autoincrement())
  nome      String   @unique @db.VarChar(255)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  @@schema("public")
}

model etiquetas {
  id               Int                @id @default(autoincrement())
  nome             String             @unique @db.VarChar(100)
  cor              String?            @default("#3B82F6") @db.VarChar(7)
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  tarefa_etiquetas tarefa_etiquetas[]

  @@schema("public")
}

model ocorrencia_anexos {
  id                 Int                @id @default(autoincrement())
  ocorrencia_id      Int
  nome_arquivo       String             @db.VarChar(255)
  url                String             @db.VarChar(500)
  created_at         DateTime?          @default(now()) @db.Timestamp(6)
  tarefa_ocorrencias tarefa_ocorrencias @relation(fields: [ocorrencia_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([ocorrencia_id], map: "idx_ocorrencia_anexos_ocorrencia")
  @@schema("public")
}

model permissoes {
  id              Int               @id @default(autoincrement())
  modulo          String            @db.VarChar(50)
  acao            String            @db.VarChar(50)
  descricao       String?
  created_at      DateTime?         @default(now()) @db.Timestamp(6)
  role_permissoes role_permissoes[]

  @@unique([modulo, acao])
  @@index([modulo], map: "idx_permissoes_modulo")
  @@schema("public")
}

model role_permissoes {
  id           Int        @id @default(autoincrement())
  role_id      Int
  permissao_id Int
  created_at   DateTime?  @default(now()) @db.Timestamp(6)
  permissoes   permissoes @relation(fields: [permissao_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  roles        roles      @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([role_id, permissao_id])
  @@index([permissao_id], map: "idx_role_permissoes_permissao")
  @@index([role_id], map: "idx_role_permissoes_role")
  @@schema("public")
}

model roles {
  id                Int               @id @default(autoincrement())
  nome              String            @unique @db.VarChar(50)
  descricao         String?
  nivel             Int
  permissoes_custom Json?             @default("{}")
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  role_permissoes   role_permissoes[]
  usuario_roles     usuario_roles[]

  @@schema("public")
}

model tarefa_anexos {
  id            Int         @id @default(autoincrement())
  atribuicao_id Int
  nome_arquivo  String      @db.VarChar(255)
  tipo          String      @db.VarChar(50)
  url           String      @db.VarChar(500)
  tamanho       Int?
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  atribuicoes   Atribuicoes @relation(fields: [atribuicao_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([atribuicao_id], map: "idx_tarefa_anexos_atribuicao")
  @@schema("public")
}

model tarefa_checklists {
  id            Int         @id @default(autoincrement())
  atribuicao_id Int
  titulo        String      @db.VarChar(255)
  concluido     Boolean?    @default(false)
  ordem         Int?        @default(0)
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  updated_at    DateTime?   @default(now()) @db.Timestamp(6)
  atribuicoes   Atribuicoes @relation(fields: [atribuicao_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([atribuicao_id], map: "idx_tarefa_checklists_atribuicao")
  @@schema("public")
}

model tarefa_compras {
  id            Int         @id @default(autoincrement())
  atribuicao_id Int
  material      String      @db.VarChar(255)
  quantidade    Decimal     @db.Decimal(10, 2)
  unidade       String?     @db.VarChar(50)
  status        String?     @default("pendente") @db.VarChar(50)
  observacoes   String?
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  updated_at    DateTime?   @default(now()) @db.Timestamp(6)
  atribuicoes   Atribuicoes @relation(fields: [atribuicao_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([atribuicao_id], map: "idx_tarefa_compras_atribuicao")
  @@index([status], map: "idx_tarefa_compras_status")
  @@schema("public")
}

model tarefa_etiquetas {
  id            Int         @id @default(autoincrement())
  atribuicao_id Int
  etiqueta_id   Int
  created_at    DateTime?   @default(now()) @db.Timestamp(6)
  atribuicoes   Atribuicoes @relation(fields: [atribuicao_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  etiquetas     etiquetas   @relation(fields: [etiqueta_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([atribuicao_id, etiqueta_id])
  @@index([atribuicao_id], map: "idx_tarefa_etiquetas_atribuicao")
  @@index([etiqueta_id], map: "idx_tarefa_etiquetas_etiqueta")
  @@schema("public")
}

model tarefa_ocorrencias {
  id                Int                 @id @default(autoincrement())
  atribuicao_id     Int
  titulo            String              @db.VarChar(255)
  descricao         String?
  gravidade         String?             @default("media") @db.VarChar(50)
  status            String?             @default("aberto") @db.VarChar(50)
  usuario_id        Int?
  created_at        DateTime?           @default(now()) @db.Timestamp(6)
  updated_at        DateTime?           @default(now()) @db.Timestamp(6)
  ocorrencia_anexos ocorrencia_anexos[]
  atribuicoes       Atribuicoes         @relation(fields: [atribuicao_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  usuarios          Usuarios?           @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([atribuicao_id], map: "idx_tarefa_ocorrencias_atribuicao")
  @@index([gravidade], map: "idx_tarefa_ocorrencias_gravidade")
  @@index([status], map: "idx_tarefa_ocorrencias_status")
  @@schema("public")
}

model usuario_roles {
  id         Int       @id @default(autoincrement())
  usuario_id Int
  role_id    Int
  created_at DateTime? @default(now()) @db.Timestamp(6)
  roles      roles     @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  usuarios   Usuarios  @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([usuario_id, role_id])
  @@index([role_id], map: "idx_usuario_roles_role")
  @@index([usuario_id], map: "idx_usuario_roles_usuario")

  @@schema("public")
}

model produtos {
  id        Int      @id @default(autoincrement())
  nome      String   @unique @db.VarChar(255)
  unidade   String?  @db.VarChar(50)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@schema("public")
}

model unidades {
  id        Int      @id @default(autoincrement())
  nome      String   @unique @db.VarChar(50)
  sigla     String   @unique @db.VarChar(10)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@schema("public")
}

model Frequencia {
  id          Int      @id @default(autoincrement())
  data        DateTime @db.Date // Apenas a data
  prestador   Prestadores @relation(fields: [prestadorId], references: [id], onDelete: Cascade)
  prestadorId Int
  obra        Obras?    @relation(fields: [obraId], references: [id], onDelete: SetNull)
  obraId      Int?
  presente    Boolean   @default(false)
  observacao  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([data, prestadorId]) // Um registro por prestador por dia
  @@map("frequencia")
  @@schema("public")
}

model Desconto {
  id          Int      @id @default(autoincrement())
  prestador   Prestadores @relation(fields: [prestadorId], references: [id], onDelete: Cascade)
  prestadorId Int
  data        DateTime @db.Date // Data do desconto
  valor       Decimal  @db.Decimal(10, 2)
  descricao   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("descontos")
  @@schema("public")
}

model Ferramentas {
  id            Int      @id @default(autoincrement())
  nome          String   @db.VarChar(255)
  marca         String?  @db.VarChar(100)
  modelo        String?  @db.VarChar(100)
  codigo        String?  @unique @db.VarChar(50) // Código de patrimônio
  status        String   @default("disponivel") @db.VarChar(50) // disponivel, em_uso, manutencao, extraviada
  foto          String?  @db.VarChar(500)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamp(6)

  movimentacoes MovimentacaoFerramentas[]

  @@map("ferramentas")
  @@schema("public")
}

model MovimentacaoFerramentas {
  id            Int      @id @default(autoincrement())
  ferramentaId  Int
  obraId        Int?     // Pode ser nulo se for retirada para manutenção externa, mas ideal ter obra
  responsavelId Int?     // Prestador responsável
  usuarioId     Int?     // Usuário que registrou a movimentação (auditoria)
  dataSaida     DateTime @default(now()) @db.Timestamp(6)
  dataDevolucao DateTime? @db.Timestamp(6)
  status        String   @default("em_uso") @db.VarChar(50) // em_uso, devolvida
  observacao    String?

  ferramenta    Ferramentas @relation(fields: [ferramentaId], references: [id], onDelete: Cascade)
  obra          Obras?      @relation(fields: [obraId], references: [id], onDelete: SetNull)
  responsavel   Prestadores? @relation(fields: [responsavelId], references: [id], onDelete: SetNull)
  usuario       Usuarios?   @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@map("movimentacao_ferramentas")
  @@schema("public")
}

model CrmLead {
  id          Int       @id @default(autoincrement())
  nome        String    @db.VarChar(255)
  empresa     String?   @db.VarChar(255)
  email       String?   @db.VarChar(255)
  telefone    String?   @db.VarChar(50)
  origem      String?   @db.VarChar(50)
  status      String    @default("novo") @db.VarChar(20)
  tipo        String    @default("PF") @db.VarChar(2)
  documento   String?   @db.VarChar(20)
  
  endereco    String?   @db.Text
  observacoes String?   @db.Text
  
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  updatedAt   DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  
  deals       CrmDeal[]
  obras       Obras[]
  
  @@map("crm_leads")
  @@schema("public")
}

model CrmDeal {
  id          Int       @id @default(autoincrement())
  titulo      String    @db.VarChar(255)
  
  leadId      Int
  lead        CrmLead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  obraId      Int?      @unique
  obra        Obras?    @relation(fields: [obraId], references: [id])
  
  valorEstimado Decimal? @default(0) @db.Decimal(15, 2)
  probabilidade Int?     @default(0)
  
  estagio     String    @default("prospeccao") @db.VarChar(50) 
  
  dataFechamentoPrevista DateTime? @db.Date
  
  propostas   Proposta[]
  
  interacoes  CrmInteracao[]
  vistoria    CrmVistoria?
  
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  updatedAt   DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  
  @@map("crm_deals")
  @@schema("public")
}

model Proposta {
  id          Int       @id @default(autoincrement())
  dealId      Int
  deal        CrmDeal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  versao      Int       @default(1)
  valor       Decimal   @db.Decimal(15, 2)
  dataEnvio   DateTime  @default(now()) @db.Timestamp(6)
  validade    DateTime? @db.Date
  
  status      String    @default("enviada") @db.VarChar(20)
  arquivoUrl  String?   @db.VarChar(500)
  
  observacoes String?   @db.Text
  
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  updatedAt   DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  
  @@map("propostas")
  @@schema("public")
}

model CrmInteracao {
  id          Int      @id @default(autoincrement())
  dealId      Int
  deal        CrmDeal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  tipo        String   @db.VarChar(50) // nota, ligacao, email, reuniao, sistema
  descricao   String   @db.Text
  
  usuarioId   Int
  usuario     Usuarios @relation(fields: [usuarioId], references: [id])
  
  data        DateTime @default(now()) @db.Timestamp(6)
  
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamp(6)
  
  @@map("crm_interacoes")
  @@schema("public")
}

model CrmVistoria {
  id          Int      @id @default(autoincrement())
  dealId      Int      @unique
  deal        CrmDeal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  respostas   Json     // { "pergunta_id": "valor", ... }
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@map("crm_vistorias")
  @@schema("public")
}

model CrmPergunta {
  id          Int      @id @default(autoincrement())
  texto       String   @db.VarChar(500)
  tipo        String   @db.VarChar(50) // numero, texto, boolean, selecao
  opcoes      Json?    // Para tipo selecao
  categoria   String   @default("Geral") @db.VarChar(100)
  ordem       Int      @default(0)
  
  // Mapeamento para orçamento
  slug        String   @unique @db.VarChar(100) // Ex: 'm2_parede'
  
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@map("crm_perguntas")
  @@schema("public")
}

// ==================== ENGENHARIA & ORÇAMENTO (BANCO DE DADOS) ====================

model InsumoMaster {
  id            Int      @id @default(autoincrement())
  codigo        String?  @unique @db.VarChar(50) // Ex: SINAPI-1234
  descricao     String
  unidade       String?  @db.VarChar(20)
  tipo          String   @default("material") @db.VarChar(50) // material, mao_de_obra, equipamento, servico
  custoPadrao   Decimal? @default(0) @db.Decimal(12, 2)
  origem        String?  @default("proprio") @db.VarChar(50) // SINAPI, ORSE, PROPRIO
  
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamp(6)
  
  itensComposicao ComposicaoItemMaster[]

  @@map("insumos_master")
  @@schema("public")
}

model ComposicaoMaster {
  id            Int      @id @default(autoincrement())
  codigo        String   @unique @db.VarChar(50) // Ex: CPU-001
  descricao     String
  unidade       String   @db.VarChar(20)
  tipo          String?  @default("proprio") @db.VarChar(50)
  
  itens         ComposicaoItemMaster[] @relation("ComposicaoPai") // Itens que fazem parte desta composição
  usadaEm       ComposicaoItemMaster[] @relation("ComposicaoFilha") // Onde esta composição é usada como sub-item

  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@map("composicoes_master")
  @@schema("public")
}

model ComposicaoItemMaster {
  id            Int               @id @default(autoincrement())
  
  composicaoId  Int
  composicao    ComposicaoMaster  @relation("ComposicaoPai", fields: [composicaoId], references: [id], onDelete: Cascade)
  
  insumoId      Int?
  insumo        InsumoMaster?     @relation(fields: [insumoId], references: [id])
  
  filhaId       Int?
  composicaoFilha ComposicaoMaster? @relation("ComposicaoFilha", fields: [filhaId], references: [id])
  
  coeficiente   Decimal           @db.Decimal(12, 4) // Quantidade necessária para 1 unidade da composição pai
  
  createdAt     DateTime          @default(now()) @db.Timestamp(6)

  @@index([composicaoId], map: "idx_comp_master_pai")
  @@map("composicao_itens_master")
  @@schema("public")
}
